#!/usr/bin/env node
// Generated by CoffeeScript 1.4.0
var activity, argv, getActivity, latestDescription, pivotal, prompt, promptSchema, _;

prompt = require('prompt');

pivotal = require('pivotal');

argv = require('optimist').argv;

_ = require('underscore');

promptSchema = {
  properties: {
    email: {
      message: 'Email',
      required: true
    },
    password: {
      hidden: true
    }
  }
};

prompt.message = " ";

prompt.delimiter = "";

activity = ['FfF'];

latestDescription = '';

prompt.get(promptSchema, function(err, result) {
  return pivotal.getToken(result.email, result.password, function(err, token) {
    pivotal.useToken(token.guid);
    if (argv.p) {
      return getActivity(argv.p);
    } else {
      return pivotal.getProjects(function(err, res) {
        console.log("Projects you belong to:");
        return _.each(res.project, function(project) {
          return console.log(project.name + ": " + project.id);
        });
      });
    }
  });
});

getActivity = function(projectID) {
  return pivotal.getActivities({
    project: projectID
  }, function(err, res) {
    var diff, latestFetchedDescription, newActivity;
    latestFetchedDescription = res.activity[0].description;
    if (latestDescription !== latestFetchedDescription) {
      latestDescription = latestFetchedDescription;
      newActivity = _.map(res.activity, function(activity) {
        return activity.description;
      });
      diff = _.difference(newActivity, activity);
      _.each(diff, function(event) {
        return console.log(event);
      });
      activity = newActivity;
    }
    return setTimeout(function() {
      return getActivity(projectID);
    }, 5000);
  });
};
